<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classeviva Web</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #121212;
      color: #e0e0e0;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .login-container {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: #1e1e1e;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2196f3;
    }

    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      background: #2a2a2a;
      border: 1px solid #444;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 16px;
    }

    input:focus {
      outline: none;
      border-color: #2196f3;
    }

    button {
      width: 100%;
      padding: 14px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #1976d2;
    }

    button:disabled {
      background: #555;
      cursor: not-allowed;
    }

    .error {
      color: #f44336;
      text-align: center;
      margin-top: 16px;
      font-size: 14px;
    }

    .app-header {
      background: #1e1e1e;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .logout-btn {
      width: auto;
      padding: 8px 16px;
      font-size: 14px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      background: #1e1e1e;
      padding: 16px 20px;
      border-bottom: 1px solid #333;
    }

    .tab {
      padding: 10px 20px;
      background: transparent;
      color: #888;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }

    .tab.active {
      background: #2196f3;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .card {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .stat-card {
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-label {
      font-size: 12px;
      color: #999;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
    }

    .grade-item {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: #252525;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .grade-value {
      min-width: 80px;
      font-size: 32px;
      font-weight: bold;
      text-align: center;
    }

    .grade-info {
      flex: 1;
    }

    .subject-bar {
      margin-bottom: 16px;
      cursor: pointer;
      padding: 12px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .subject-bar:hover {
      background: #252525;
    }

    .subject-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .progress-bar {
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s;
    }

    .warning {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .loading {
      text-align: center;
      padding: 40px;
    }

    .spinner {
      border: 4px solid #333;
      border-top: 4px solid #2196f3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden {
      display: none;
    }

    .setup-notice {
      background: #ff9800;
      color: #000;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .setup-notice strong {
      display: block;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div id="loginScreen" class="login-container">
    <h1>Classeviva Web</h1>
    <input type="text" id="username" placeholder="Username (es. S1234567C)">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()" id="loginBtn">Accedi</button>
    <div id="loginError" class="error"></div>
  </div>

  <div id="appScreen" class="hidden">
    <div class="app-header">
      <h2>Benvenuto, <span id="userName"></span></h2>
      <button class="logout-btn" onclick="logout()">Esci</button>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('voti')">üìä Voti</button>
      <button class="tab" onclick="switchTab('assenze')">üö´ Assenze</button>
    </div>

    <div class="container">
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Caricamento dati...</p>
      </div>

      <div id="votiTab" class="tab-content active">
        <div class="card">
          <h3>MEDIE GENERALI</h3>
          <div class="stats-grid" id="generalStats"></div>
        </div>

        <div class="card">
          <h3>MEDIE PER MATERIA (Q<span id="currentQ"></span>)</h3>
          <div id="subjectStats"></div>
        </div>

        <div class="card">
          <h3>TUTTI I VOTI</h3>
          <div id="gradesList"></div>
        </div>
      </div>

      <div id="assenzeTab" class="tab-content">
        <div class="card">
          <h3>PROGRESSO ASSENZE</h3>
          <div id="absenceProgress"></div>
        </div>

        <div class="card">
          <h3>STATISTICHE</h3>
          <div class="stats-grid" id="absenceStats"></div>
        </div>

        <div class="card">
          <h3>DETTAGLIO</h3>
          <div id="absenceList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://classeviva-client.vercel.app/api/classeviva';
    
    let authData = null;
    let gradesData = [];
    let absencesData = [];

    // Check if already logged in
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('classeviva_auth');
      if (saved) {
        authData = JSON.parse(saved);
        autoLogin();
      }
    });

    async function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const btn = document.getElementById('loginBtn');
      const error = document.getElementById('loginError');

      if (!username || !password) {
        error.textContent = 'Inserisci username e password';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Accesso in corso...';
      error.textContent = '';

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'login', username, password })
        });

        if (!res.ok) throw new Error('Login fallito');

        const data = await res.json();
        authData = { ...data, username, password };
        localStorage.setItem('classeviva_auth', JSON.stringify(authData));

        await loadUserData();
      } catch (e) {
        error.textContent = 'Login fallito: ' + e.message;
        btn.disabled = false;
        btn.textContent = 'Accedi';
      }
    }

    async function autoLogin() {
      try {
        await loadUserData();
      } catch (e) {
        localStorage.removeItem('classeviva_auth');
        authData = null;
        document.getElementById('loginScreen').classList.remove('hidden');
      }
    }

    async function loadUserData() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('appScreen').classList.remove('hidden');
      document.getElementById('loading').classList.remove('hidden');

      try {
        const [carta, voti, assenze] = await Promise.all([
          apiCall('carta'),
          apiCall('voti'),
          apiCall('assenze')
        ]);

        const nome = carta.firstName || authData.username;
        document.getElementById('userName').textContent = nome;

        gradesData = voti;
        absencesData = assenze;

        renderGrades();
        renderAbsences();
      } catch (e) {
        alert('Errore caricamento dati: ' + e.message);
      } finally {
        document.getElementById('loading').classList.add('hidden');
      }
    }

    async function apiCall(action) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action,
          token: authData.token,
          userId: authData.userId
        })
      });

      if (!res.ok) throw new Error(`API error: ${action}`);
      return res.json();
    }

    function logout() {
      localStorage.removeItem('classeviva_auth');
      location.reload();
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    function determineQuarter(dateStr) {
      const d = new Date(dateStr);
      if (d.getMonth() >= 8 || (d.getMonth() === 0 && d.getDate() <= 28)) return 1;
      if ((d.getMonth() === 0 && d.getDate() > 28) || (d.getMonth() >= 1 && d.getMonth() <= 5)) return 2;
      return 0;
    }

    function parseGrade(val) {
      const clean = val.replace(/[,+\-]/g, '.').replace('¬Ω', '.5');
      const num = parseFloat(clean);
      return isNaN(num) ? null : num;
    }

    function renderGrades() {
      const now = new Date();
      const currentQ = (now.getMonth() >= 8 || (now.getMonth() === 0 && now.getDate() <= 28)) ? 1 : 2;
      document.getElementById('currentQ').textContent = currentQ;

      let q1Grades = [], q2Grades = [], allGrades = [];
      let bySubject = {};
      let bySubjectByQ = {};

      gradesData.forEach(g => {
        if (g.color === 'blue') return;
        
        const val = parseGrade(g.displayValue || g.decimalValue?.toString() || '');
        if (!val) return;

        const q = determineQuarter(g.evtDate || '');
        const subj = g.subjectDesc || 'N/A';

        allGrades.push(val);
        if (q === 1) q1Grades.push(val);
        if (q === 2) q2Grades.push(val);

        if (!bySubject[subj]) bySubject[subj] = [];
        bySubject[subj].push(val);

        if (!bySubjectByQ[subj]) bySubjectByQ[subj] = { 1: [], 2: [] };
        if (q === 1) bySubjectByQ[subj][1].push(val);
        if (q === 2) bySubjectByQ[subj][2].push(val);
      });

      const avg = arr => arr.length ? arr.reduce((a,b) => a+b) / arr.length : 0;

      // General stats
      const genHtml = `
        <div class="stat-card" style="background: rgba(33,150,243,0.2);">
          <div class="stat-label">Media Totale</div>
          <div class="stat-value" style="color: ${avg(allGrades) >= 6 ? '#4caf50' : '#f44336'}">
            ${avg(allGrades).toFixed(2)}
          </div>
        </div>
        <div class="stat-card" style="background: rgba(76,175,80,0.2);">
          <div class="stat-label">Q1</div>
          <div class="stat-value" style="color: ${avg(q1Grades) >= 6 ? '#4caf50' : '#f44336'}">
            ${avg(q1Grades).toFixed(2)}
          </div>
        </div>
        <div class="stat-card" style="background: rgba(156,39,176,0.2);">
          <div class="stat-label">Q2</div>
          <div class="stat-value" style="color: ${avg(q2Grades) >= 6 ? '#4caf50' : '#f44336'}">
            ${avg(q2Grades).toFixed(2)}
          </div>
        </div>
      `;
      document.getElementById('generalStats').innerHTML = genHtml;

      // Subject stats sorted by current quarter
      const sortedSubjects = Object.entries(bySubject).sort((a, b) => {
        const avgA = avg(bySubjectByQ[a[0]][currentQ]);
        const avgB = avg(bySubjectByQ[b[0]][currentQ]);
        return avgB - avgA;
      });

      const subjHtml = sortedSubjects.map(([subj, grades]) => {
        const qAvg = avg(bySubjectByQ[subj][currentQ]);
        const qCount = bySubjectByQ[subj][currentQ].length;
        const color = qAvg >= 6 ? '#4caf50' : '#f44336';
        
        return `
          <div class="subject-bar">
            <div class="subject-header">
              <span style="font-weight: 500;">${subj}</span>
              <div style="display: flex; align-items: center; gap: 8px;">
                ${qCount < 3 ? `<span class="warning">‚ö†Ô∏è solo ${qCount} voti</span>` : ''}
                <span style="font-weight: bold; color: ${color}; font-size: 16px;">
                  ${qAvg > 0 ? qAvg.toFixed(2) : 'N/A'}
                </span>
              </div>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${qAvg * 10}%; background: ${color};"></div>
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('subjectStats').innerHTML = subjHtml;

      // All grades list
      const sorted = [...gradesData].sort((a, b) => {
        const dA = new Date(a.evtDate || 0);
        const dB = new Date(b.evtDate || 0);
        return dB - dA;
      });

      const listHtml = sorted.map(g => {
        const val = g.displayValue || g.decimalValue?.toString() || 'N/A';
        const isBlue = g.color === 'blue';
        const numVal = parseGrade(val);
        const color = isBlue ? '#2196f3' : (numVal >= 6 ? '#4caf50' : '#f44336');
        const q = determineQuarter(g.evtDate || '');
        
        return `
          <div class="grade-item">
            <div class="grade-value" style="color: ${color};">
              ${val}<br>
              <span style="font-size: 10px; color: #999;">
                ${g.evtDate || 'N/A'}${q ? ' [Q'+q+']' : ''}
              </span>
            </div>
            <div class="grade-info">
              <div style="font-weight: bold; font-size: 16px;">${g.subjectDesc || 'N/A'}</div>
              <div style="font-size: 13px; color: #aaa;">${g.componentDesc || 'N/A'}</div>
              ${g.notesForFamily ? `<div style="font-size: 11px; color: #888; margin-top: 4px;">${g.notesForFamily}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('gradesList').innerHTML = listHtml;
    }

    function renderAbsences() {
      let totali = 0, ritardi = 0, uscite = 0;
      absencesData.forEach(a => {
        if (a.evtCode === 'ABA0') totali++;
        else if (a.evtCode === 'ABR0') ritardi++;
        else if (a.evtCode === 'ABU0') uscite++;
      });

      // Progress
      const now = new Date();
      const year = now.getMonth() >= 8 ? now.getFullYear() : now.getFullYear() - 1;
      const startDate = new Date(year, 8, 15);
      const endDate = new Date(year + 1, 5, 10);
      const totalDays = Math.floor((endDate - startDate) / 86400000);
      const elapsed = Math.floor((now - startDate) / 86400000);
      const yearPct = Math.min(100, (elapsed / totalDays * 100));
      
      const maxAbs = 50;
      const absPct = Math.min(100, (totali / maxAbs * 100));
      const absColor = absPct > 80 ? '#f44336' : (absPct > 50 ? '#ff9800' : '#4caf50');

      document.getElementById('absenceProgress').innerHTML = `
        <div style="margin-bottom: 24px;">
          <div style="color: #999; margin-bottom: 8px;">Anno trascorso: ${yearPct.toFixed(1)}%</div>
          <div class="progress-bar" style="height: 24px;">
            <div class="progress-fill" style="width: ${yearPct}%; background: #2196f3;"></div>
          </div>
        </div>
        <div>
          <div style="color: #999; margin-bottom: 8px;">Assenze: ${totali} / ${maxAbs} (${absPct.toFixed(1)}%)</div>
          <div class="progress-bar" style="height: 24px;">
            <div class="progress-fill" style="width: ${absPct}%; background: ${absColor};"></div>
          </div>
          ${absPct > yearPct ? `
            <div style="background: rgba(244,67,54,0.2); color: #f44336; padding: 12px; border-radius: 8px; margin-top: 12px;">
              ‚ö†Ô∏è Attenzione: stai facendo pi√π assenze del dovuto!
            </div>
          ` : ''}
        </div>
      `;

      document.getElementById('absenceStats').innerHTML = `
        <div class="stat-card" style="background: rgba(244,67,54,0.2);">
          <div class="stat-label">Assenze</div>
          <div class="stat-value" style="color: #f44336;">${totali}</div>
        </div>
        <div class="stat-card" style="background: rgba(255,152,0,0.2);">
          <div class="stat-label">Ritardi</div>
          <div class="stat-value" style="color: #ff9800;">${ritardi}</div>
        </div>
        <div class="stat-card" style="background: rgba(255,87,34,0.2);">
          <div class="stat-label">Uscite</div>
          <div class="stat-value" style="color: #ff5722;">${uscite}</div>
        </div>
      `;

      const listHtml = absencesData.slice(0, 20).map(a => {
        const types = {
          'ABA0': { label: 'Assenza', color: '#f44336' },
          'ABR0': { label: 'Ritardo', color: '#ff9800' },
          'ABU0': { label: 'Uscita', color: '#ff5722' }
        };
        const type = types[a.evtCode] || { label: 'Altro', color: '#999' };
        const isJust = a.isJustified;

        return `
          <div class="grade-item">
            <div style="width: 50px; text-align: center; color: ${type.color}; font-size: 32px;">
              üö´
            </div>
            <div class="grade-info">
              <div style="font-weight: bold;">${type.label}</div>
              <div style="font-size: 13px; color: #aaa;">${a.evtDate || 'N/A'}</div>
            </div>
            <div style="background: ${isJust ? 'rgba(76,175,80,0.2)' : 'rgba(255,152,0,0.2)'}; 
                        color: ${isJust ? '#4caf50' : '#ff9800'}; 
                        padding: 6px 12px; border-radius: 12px; font-size: 12px;">
              ${isJust ? 'Giustificata' : 'Da giustificare'}
            </div>
          </div>
        `;
      }).join('');
      document.getElementById('absenceList').innerHTML = listHtml;
    }
  </script>
</body>
</html>
